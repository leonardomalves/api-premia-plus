# âš™ï¸ Copilot Rules â€” API Premia Plus (Laravel 12)

## ðŸ§© Contexto do Projeto
**API de sistema de rifas e comissÃµes** estruturada em camadas (Controllers, Requests, Services, Jobs, Models).
**DomÃ­nio:** Users, Plans, Orders, Carts, Raffles, Tickets, Commissions, Wallets.
**Arquitetura:** API versionada (v1) com autenticaÃ§Ã£o Sanctum, Jobs assÃ­ncronos, BusinessRules services.

**PrincÃ­pios de desenvolvimento:**
- **SOLID** e **PSR-12**
- **Performance-first** - cache, consultas otimizadas, Jobs para tarefas pesadas  
- **Responsabilidade Ãºnica** - Controllers finos, Services especializados
- **Zero redundÃ¢ncia** - DRY, reutilizaÃ§Ã£o, padrÃµes consistentes

---

## âš¡ Diretrizes Gerais
- CÃ³digo **tipado** (`declare(strict_types=1);`)
- Controllers finos, delegando tudo para Services.
- Services com regras claras de negÃ³cio e sem dependÃªncias cÃ­clicas.
- **JAMAIS usar mensagens hard-coded** - usar `__('app.key')` SEMPRE
- Evitar helpers (`dd`, `dump`, `env`).
- Sempre validar com `FormRequest` e retornar JSON padronizado.
- Adotar Jobs para operaÃ§Ãµes demoradas.
- Usar `Cache`, `chunk()`, `cursor()` e `paginate()` para performance.
- Sempre usar artisan commands em scripts de deploy (cache, migrate, etc).
- Sempre usar PSR-12 e linters (PHPStan, PHPCS).
- Sempre usar artisan para criar arquivos (make:model, make:controller, etc).
- Quando criar uma model nova, criar tambÃ©m o factory e o seeder correspondentes utilisando o -m para criar a migration junto.
- Sempre atulize a collection do postman com as novas rotas criadas no diretÃ³rio docs, nÃ£o precisar cirar uma nova caso exita, apenas atualize.
---

## ðŸ§± Eloquent e Consultas
- **Models com UUIDs:** usar `Str::uuid()` no boot, SoftDeletes quando aplicÃ¡vel
- **Scopes padrÃ£o:** `scopeActive()`, `scopeByCreator()` - seguir padrÃ£o do projeto
- **Nunca usar `Model::all()`** â€” sempre aplicar filtros, scopes e limites
- **Especificar colunas** com `select(['id', 'uuid', 'name'])`
- **Relationships:** definir claramente `belongsTo`, `hasMany`, `belongsToMany` com pivots
- **Cachear consultas caras:**
  ```php
  Cache::remember('active_raffles', now()->addMinutes(10), fn() =>
      Raffle::active()->with('creator')->get()
  );
  ```
- **Prevenir N+1:** sempre usar `with()` para relationships necessÃ¡rias
- **Usar agregaÃ§Ãµes:** `exists()`, `withCount()`, `sum()` em vez de loops

---

## ðŸ§© Services
- **Estrutura:** `app/Services/{Domain}/` (Administrator, BusinessRules, Customer, Core, Monitoring)
- **BusinessRules:** `ExecuteBusinessRule`, `PayCommissionService`, `CreateStatementService`, `WalletTicketService`
- **InjeÃ§Ã£o de dependÃªncia** no construtor para outros services
- **MÃ©todos:** `execute()`, `process()`, `create()`, `update()` - sempre retornar arrays estruturados
- Processar **em lote** sempre que possÃ­vel (`insert`, `updateBatch`)
- Usar `readonly` e `final` quando aplicÃ¡vel

---

## ðŸ§µ Jobs
- Local: `app/Jobs`
- Sempre implementar `ShouldQueue` com `tries = 3` e `timeout = 120`
- Jobs devem ser idempotentes com logs estruturados (usar emojis)
- Usar `Bus::batch()` para orquestrar execuÃ§Ãµes em paralelo
- Exemplo: `AbandonedCartJob`, `CreateTicketsBatchJob`, `ExecuteBusinessRuleJob`

---

## ðŸ§° Performance Laravel
- Ativar `config:cache`, `route:cache`, `view:cache`.
- Usar `php artisan optimize:clear` apenas em ambiente de desenvolvimento.
- Evitar chamadas IO sÃ­ncronas no ciclo da request.
- Adotar Octane (Swoole ou RoadRunner) em produÃ§Ã£o.
- Minimizar overhead de IoC â€” usar `singleton()` onde possÃ­vel.

## ðŸ” Middlewares DisponÃ­veis
- **`auth:sanctum`** - AutenticaÃ§Ã£o por Bearer Token
- **`admin`** - ValidaÃ§Ã£o de usuÃ¡rio administrador  
- **`api.key`** - ValidaÃ§Ã£o de API Key via header `X-API-Key`

### Middleware API Key
```php
// Uso bÃ¡sico
Route::middleware(['api.key'])->group(function () {
    Route::post('/webhooks/payment', 'WebhookController@handle');
});

// Combinado com autenticaÃ§Ã£o
Route::middleware(['api.key', 'auth:sanctum', 'admin'])->group(function () {
    Route::get('/admin/reports', 'AdminController@reports');
});
```

**ConfiguraÃ§Ã£o:** 
- Header: `X-API-Key: sk_api_[64-char-hex]`
- Env: `APP_API_KEY=sk_api_...`
- Uso: Webhooks, operaÃ§Ãµes crÃ­ticas, comunicaÃ§Ã£o entre serviÃ§os

---

## ðŸ§¾ PadrÃ£o de Resposta (OBRIGATÃ“RIO)
**Sucesso:**
```json
{
  "status": "success",
  "message": "{{ __('app.domain.action') }}",
  "data": { ... },
  "meta": { "execution_time_ms": 8.45 }
}
```

**Erro:**
```json
{
  "status": "error",
  "message": "{{ __('app.domain.error') }}",
  "errors": { "field": "Detalhes do erro" }
}
```

**Regras:**
- âœ… **SEMPRE** usar `status` (nÃ£o `success`)
- âœ… **SEMPRE** usar traduÃ§Ãµes `__('app.key')` nas mensagens
- âœ… **SEMPRE** incluir `meta.execution_time_ms` em sucessos
- âœ… **SEMPRE** usar `errors` como objeto em falhas

---

## ðŸŒ Sistema de TraduÃ§Ãµes (OBRIGATÃ“RIO)
### **REGRA FUNDAMENTAL: ZERO MENSAGENS HARD-CODED**
- **Arquivo principal:** `lang/pt_BR/app.php` - todas as mensagens customizadas
- **Laravel padrÃ£o:** `lang/pt_BR/validation.php`, `auth.php`, `passwords.php`
- **Uso obrigatÃ³rio:** `__('app.profile.updated')` em vez de `'Perfil atualizado'`
- **Logs traduzidos:** `Log::info('ðŸ‘¥ ' . __('app.logs.searching_user_network'))`
- **Estrutura organizada:** `app.{domain}.{action}` (ex: `app.user.not_found`)

### **Exemplos PrÃ¡ticos:**
```php
// âŒ ERRADO - mensagem hard-coded
return response()->json(['message' => 'UsuÃ¡rio nÃ£o encontrado'], 404);

// âœ… CORRETO - traduÃ§Ã£o
return response()->json(['message' => __('app.user.not_found')], 404);

// âŒ ERRADO - log hard-coded  
Log::info('Buscando usuÃ¡rio');

// âœ… CORRETO - log traduzido
Log::info('ðŸ” ' . __('app.logs.searching_user'));
```

### **Estrutura do arquivo app.php:**
- `app.profile.*` - operaÃ§Ãµes de perfil
- `app.user.*` - operaÃ§Ãµes de usuÃ¡rio  
- `app.validation.*` - validaÃ§Ãµes customizadas
- `app.logs.*` - mensagens de log
- `app.jobs.*` - mensagens de jobs

---

## ï¿½ðŸŽ¯ PadrÃµes EspecÃ­ficos do Projeto
- **Rotas API:** `routes/api/v1/{auth,customer,administrator,shared}.php`
- **Controllers:** `app/Http/Controllers/Api/{Customer,Administrator}/`
- **Middleware:** `auth:sanctum` para rotas protegidas
- **UUID patterns:** todos os models principais usam UUID como identificador externo
- **Logs com emojis:** facilita debug - `ðŸ›’`, `ðŸ“Š`, `âœ…`, `âŒ`, `ðŸ“§`
- **Status constants:** definir no Model (STATUS_DRAFT, STATUS_ACTIVE, etc.)

---

## ðŸ§  InstruÃ§Ãµes para Copilot
Ao gerar cÃ³digo:
1. **Priorize performance e seguranÃ§a** - cache, validaÃ§Ã£o, sanitizaÃ§Ã£o
2. **Tipagem obrigatÃ³ria** - `declare(strict_types=1)` em todos os arquivos
3. **Consultas otimizadas** - scopes, with(), select especÃ­fico, cache
4. **Logs estruturados** - contexto rico, emojis, arrays de dados
5. **Jobs idempotentes** - tries=3, timeout=120, logs de inÃ­cio/fim
6. **BusinessRules services** - lÃ³gica complexa isolada, injeÃ§Ã£o de dependÃªncia
7. **Nunca usar helpers debug** - sem `dd()`, `dump()`, `env()` direto
8. **ZERO mensagens hard-coded** - usar `__('app.key')` Ã© OBRIGATÃ“RIO
9. **TraduÃ§Ãµes centralizadas** - `lang/pt_BR/app.php` para tudo
10. **Logs com traduÃ§Ãµes** - `Log::info('ðŸ” ' . __('app.logs.action'))`
11. **JSON padronizado** - status/message/data/meta para sucesso, status/message/errors para falha
12. **Middlewares apropriados** - api.key para webhooks, auth:sanctum para usuÃ¡rios, admin para administraÃ§Ã£o
13. **Type casting seguro** - (string), (int) quando necessÃ¡rio para strict types
14. **ValidaÃ§Ã£o com FormRequest** - nunca validar diretamente no Controller

---

## ðŸ”€ Boas PrÃ¡ticas Git
### **Commits SemÃ¢nticos**
```
feat: adicionar endpoint para cancelar tickets de rifa
fix: corrigir cÃ¡lculo de comissÃµes em mÃºltiplos nÃ­veis  
refactor: extrair lÃ³gica de pagamento para PayCommissionService
docs: atualizar documentaÃ§Ã£o da API de cartÃµes
test: adicionar testes para AbandonedCartJob
chore: atualizar dependÃªncias do Laravel para v12.1
```

### **Branches Organizadas**
- **feature/** - novas funcionalidades (`feature/raffle-ticket-cancellation`)
- **fix/** - correÃ§Ãµes de bugs (`fix/commission-calculation-error`)  
- **hotfix/** - correÃ§Ãµes urgentes em produÃ§Ã£o (`hotfix/payment-gateway-timeout`)
- **refactor/** - melhorias de cÃ³digo (`refactor/extract-business-rules-services`)

### **Pull Requests**
- **MÃ¡ximo 500 linhas** por PR - se maior, quebrar em mÃºltiplos PRs
- **TÃ­tulo descritivo** seguindo padrÃ£o semÃ¢ntico
- **DescriÃ§Ã£o clara:** O que mudou, por que mudou, como testar
- **Review obrigatÃ³rio** antes do merge
- **Testes passando** - CI/CD deve estar verde

### **Arquivos Ignorados**
Nunca commitar:
- `.env*` (credenciais e configuraÃ§Ãµes)
- `storage/logs/*` (logs de aplicaÃ§Ã£o)
- `bootstrap/cache/*` (cache do Laravel)
- `node_modules/` (dependÃªncias JS)
- `.DS_Store`, `Thumbs.db` (sistema operacional)

---

ðŸ¦¾ **Resumo Final**
> Sistema de rifas e comissÃµes com foco em performance e seguranÃ§a.  
> Controllers finos, BusinessRules services, Jobs assÃ­ncronos, Models com UUIDs.  
> **REGRA ABSOLUTA: TraduÃ§Ãµes obrigatÃ³rias, zero strings hard-coded.**  
> **JSON padronizado: status/message/data/meta sempre.**  
> **Middlewares: api.key para seguranÃ§a, auth:sanctum para usuÃ¡rios.**  
> **Tipagem estrita: declare(strict_types=1) em TODOS os arquivos.**  
> **Git semÃ¢ntico, PRs pequenos, branches organizadas.**

**Status de Compliance: 100% âœ…**  
- âœ… Strict typing em todos os arquivos PHP
- âœ… Sistema de traduÃ§Ãµes completo (80+ mensagens)
- âœ… JSON responses padronizados
- âœ… Middleware de API Key implementado
- âœ… FormRequests para validaÃ§Ã£o
- âœ… Performance otimizada com cache
