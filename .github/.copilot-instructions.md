# ‚öôÔ∏è Copilot Rules ‚Äî API Premia Plus (Laravel 12)

## üß© Contexto do Projeto
**API de sistema de rifas e comiss√µes** estruturada em camadas (Controllers, Requests, Services, Jobs, Models).
**Dom√≠nio:** Users, Plans, Orders, Carts, Raffles, Tickets, Commissions, Wallets, **Subscribers** (Lead Tracking).
**Arquitetura:** API versionada (v1) com autentica√ß√£o Sanctum, Jobs ass√≠ncronos, BusinessRules services, **API p√∫blica para landing pages**.

**Princ√≠pios de desenvolvimento:**
- **SOLID** e **PSR-12**
- **Performance-first** - cache, consultas otimizadas, Jobs para tarefas pesadas  
- **Responsabilidade √∫nica** - Controllers finos, Services especializados
- **Zero redund√¢ncia** - DRY, reutiliza√ß√£o, padr√µes consistentes

---

## ‚ö° Diretrizes Gerais
- C√≥digo **tipado** (`declare(strict_types=1);`)
- Controllers finos, delegando tudo para Services.
- Services com regras claras de neg√≥cio e sem depend√™ncias c√≠clicas.
- **JAMAIS usar mensagens hard-coded** - usar `__('app.key')` SEMPRE
- Evitar helpers (`dd`, `dump`, `env`).
- Sempre validar com `FormRequest` e retornar JSON padronizado.
- Adotar Jobs para opera√ß√µes demoradas.
- Usar `Cache`, `chunk()`, `cursor()` e `paginate()` para performance.
- Sempre usar artisan commands em scripts de deploy (cache, migrate, etc).
- Sempre usar PSR-12 e linters (PHPStan, PHPCS).
- Sempre usar artisan para criar arquivos (make:model, make:controller, etc).
- Quando criar uma model nova, criar tamb√©m o factory e o seeder correspondentes utilisando o -m para criar a migration junto.
- **Collections Postman organizadas por dom√≠nio** em `docs/postman/collections/{Domain}/`
- **Estrutura implementada:**
  - `Users/` - Autentica√ß√£o completa, gest√£o de usu√°rios, admin CRUD
  - `Subscribers/` - Lead capture, UTM tracking, unsubscribe
  - `Orders/` - Carrinho, pedidos, hist√≥rico, admin management
  - `Raffles/` - *Em desenvolvimento* - rifas e sorteios
  - `Commissions/` - *Em desenvolvimento* - sistema de comiss√µes
- **Environments organizados** em `docs/postman/environments/` (Local, Production)
- **Scripts autom√°ticos** inclu√≠dos: extra√ß√£o de tokens, UUIDs, testes de valida√ß√£o
- **Documenta√ß√£o completa** em `docs/postman/collections/README.md`
- **SEMPRE atualizar collections** ao criar novos endpoints
- **Para cada nova funcionalidade:** adicionar testes unit√°rios e de integra√ß√£o
- **Para cada dom√≠nio conclu√≠do:** criar arquivo em `docs/integrations/{domain}.md` com instru√ß√µes para front-end
---

## üß± Eloquent e Consultas
- **Models com UUIDs:** usar `Str::uuid()` no boot, SoftDeletes quando aplic√°vel
- **Scopes padr√£o:** `scopeActive()`, `scopeByCreator()` - seguir padr√£o do projeto
- **Nunca usar `Model::all()`** ‚Äî sempre aplicar filtros, scopes e limites
- **Especificar colunas** com `select(['id', 'uuid', 'name'])`
- **Relationships:** definir claramente `belongsTo`, `hasMany`, `belongsToMany` com pivots
- **Cachear consultas caras:**
  ```php
  Cache::remember('active_raffles', now()->addMinutes(10), fn() =>
      Raffle::active()->with('creator')->get()
  );
  ```
- **Prevenir N+1:** sempre usar `with()` para relationships necess√°rias
- **Usar agrega√ß√µes:** `exists()`, `withCount()`, `sum()` em vez de loops

---

## üß© Services
- **Estrutura:** `app/Services/{Domain}/` (Administrator, BusinessRules, Customer, Core, Monitoring)
- **BusinessRules:** `ExecuteBusinessRule`, `PayCommissionService`, `CreateStatementService`, `WalletTicketService`
- **Customer:** `SubscriberService` - Lead tracking, convers√£o, device fingerprinting
- **Inje√ß√£o de depend√™ncia** no construtor para outros services
- **M√©todos:** `execute()`, `process()`, `create()`, `update()` - sempre retornar arrays estruturados
- Processar **em lote** sempre que poss√≠vel (`insert`, `updateBatch`)
- Usar `readonly` e `final` quando aplic√°vel

---

## üßµ Jobs
- Local: `app/Jobs`
- Sempre implementar `ShouldQueue` com `tries = 3` e `timeout = 120`
- Jobs devem ser idempotentes com logs estruturados (usar emojis)
- Usar `Bus::batch()` para orquestrar execu√ß√µes em paralelo
- Exemplo: `AbandonedCartJob`, `CreateTicketsBatchJob`, `ExecuteBusinessRuleJob`

---

## üß∞ Performance Laravel
- Ativar `config:cache`, `route:cache`, `view:cache`.
- Usar `php artisan optimize:clear` apenas em ambiente de desenvolvimento.
- Evitar chamadas IO s√≠ncronas no ciclo da request.
- Adotar Octane (Swoole ou RoadRunner) em produ√ß√£o.
- Minimizar overhead de IoC ‚Äî usar `singleton()` onde poss√≠vel.

## üîê Middlewares Dispon√≠veis
- **`auth:sanctum`** - Autentica√ß√£o por Bearer Token
- **`admin`** - Valida√ß√£o de usu√°rio administrador  
- **`api.key`** - Valida√ß√£o de API Key via header `X-API-Key`
- **`throttle:lead-capture`** - Rate limiting para captura de leads (5/min)
- **`throttle:lead-status`** - Rate limiting para verifica√ß√£o de status (10/min)
- **`throttle:lead-unsubscribe`** - Rate limiting para unsubscribe (3/min)

### Middleware API Key
```php
// Uso b√°sico
Route::middleware(['api.key'])->group(function () {
    Route::post('/webhooks/payment', 'WebhookController@handle');
});

// Combinado com autentica√ß√£o
Route::middleware(['api.key', 'auth:sanctum', 'admin'])->group(function () {
    Route::get('/admin/reports', 'AdminController@reports');
});
```

**Configura√ß√£o:** 
- Header: `X-API-Key: sk_api_[64-char-hex]`
- Env: `APP_API_KEY=sk_api_...`
**Uso:** Webhooks, opera√ß√µes cr√≠ticas, comunica√ß√£o entre servi√ßos

### APIs P√∫blicas (Lead Tracking)
**Rotas:** `routes/api/v1/public.php`
- **Rate Limited:** Prote√ß√£o contra spam por IP
- **Stateless:** N√£o dependem de sess√µes ou autentica√ß√£o
- **UTM Tracking:** Captura autom√°tica de par√¢metros de campanha
- **Device Fingerprinting:** IP, User-Agent, detec√ß√£o de dispositivo

```php
// Captura de leads (landing pages)
POST   /api/v1/public/leads/capture
GET    /api/v1/public/leads/status/{uuid}  
DELETE /api/v1/public/leads/unsubscribe/{uuid}
```

---

## üìö Collections Postman - Organiza√ß√£o por Dom√≠nio
**Estrutura:** `docs/postman/collections/{Domain}/`

### üë• Users & Authentication
**Arquivo:** `Users/Premia_Club_Users_API.postman_collection.json`
- ‚úÖ **Login/Logout** - Autentica√ß√£o completa com refresh tokens
- ‚úÖ **Register** - Registro de usu√°rios com valida√ß√£o completa
- ‚úÖ **Profile Management** - Atualiza√ß√£o de perfil, avatar, configura√ß√µes
- ‚úÖ **Admin CRUD** - Gest√£o administrativa de usu√°rios
- ‚úÖ **Scripts Autom√°ticos** - Extra√ß√£o de auth_token, user_uuid
- ‚úÖ **Tests** - Valida√ß√£o de estrutura, performance, autentica√ß√£o

### üìß Subscribers (Lead Capture)  
**Arquivo:** `Subscribers/Premia_Club_Lead_Capture_API.postman_collection.json`
- ‚úÖ **Lead Capture** - Captura com UTM tracking e device fingerprinting
- ‚úÖ **Status Check** - Verifica√ß√£o de status de leads
- ‚úÖ **Unsubscribe** - Sistema de descadastro
- ‚úÖ **Rate Limiting** - Testes de prote√ß√£o contra spam
- ‚úÖ **Scripts Autom√°ticos** - Gera√ß√£o de emails √∫nicos, extra√ß√£o de UUIDs
- ‚úÖ **Tests** - Valida√ß√£o de rate limits, estruturas, convers√µes

### üõí Orders & Cart
**Arquivo:** `Orders/Premia_Club_Orders_API.postman_collection.json`
- ‚úÖ **Shopping Cart** - Adicionar/remover itens, verificar total
- ‚úÖ **Order Creation** - Criar pedidos com m√∫ltiplos m√©todos de pagamento
- ‚úÖ **Order History** - Hist√≥rico de compras do usu√°rio
- ‚úÖ **Admin Management** - Gest√£o administrativa de pedidos
- ‚úÖ **Scripts Autom√°ticos** - Extra√ß√£o de cart_uuid, order_uuid
- ‚úÖ **Tests** - Valida√ß√£o de carrinho, pedidos, status de pagamento

### üéØ Raffles *(Em Desenvolvimento)*
**Diret√≥rio:** `Raffles/` - Estrutura criada, aguardando implementa√ß√£o
- üöß **Public Listings** - Listagem p√∫blica de rifas
- üöß **Ticket Purchase** - Compra de tickets 
- üöß **Draw Results** - Resultados dos sorteios
- üöß **Admin CRUD** - Gest√£o de rifas

### üí∞ Commissions *(Em Desenvolvimento)*
**Diret√≥rio:** `Commissions/` - Estrutura criada, aguardando implementa√ß√£o
- üöß **Reports** - Relat√≥rios de comiss√µes
- üöß **Earnings History** - Hist√≥rico de ganhos
- üöß **Level Configuration** - Configura√ß√£o de n√≠veis

### üåç Environments
**Localiza√ß√µes:** `docs/postman/environments/`
- **Local:** `Premia_Club_Local_Environment.postman_environment.json`
- **Production:** `Premia_Club_Production_Environment.postman_environment.json`
- **Vari√°veis autom√°ticas:** auth_token, user_uuid, cart_uuid, order_uuid
- **Configura√ß√£o:** base_url, api_key, admin_email por environment

### üìñ Documenta√ß√£o
- **Guia completo:** `docs/postman/collections/README.md`
- **Instru√ß√µes de uso:** Importa√ß√£o, configura√ß√£o, execu√ß√£o
- **Scripts autom√°ticos:** Descri√ß√£o completa das funcionalidades
- **Padr√µes de desenvolvimento:** Contribui√ß√£o e manuten√ß√£o

### üîß Funcionalidades Autom√°ticas
- **Auto-authentication:** Tokens salvos automaticamente nas vari√°veis
- **Dynamic Variables:** UUIDs e IDs extra√≠dos das respostas
- **Comprehensive Tests:** Valida√ß√£o de estrutura, performance, neg√≥cio
- **Performance Monitoring:** M√©tricas de execution_time_ms inclu√≠das
- **Pre-request Scripts:** Headers, valida√ß√µes, configura√ß√µes autom√°ticas

---

## üßæ Padr√£o de Resposta (OBRIGAT√ìRIO)
**Sucesso:**
```json
{
  "status": "success",
  "message": "{{ __('app.domain.action') }}",
  "data": { ... },
  "meta": { "execution_time_ms": 8.45 }
}
```

**Erro:**
```json
{
  "status": "error",
  "message": "{{ __('app.domain.error') }}",
  "errors": { "field": "Detalhes do erro" }
}
```

**Regras:**
- ‚úÖ **SEMPRE** usar `status` (n√£o `success`)
- ‚úÖ **SEMPRE** usar tradu√ß√µes `__('app.key')` nas mensagens
- ‚úÖ **SEMPRE** incluir `meta.execution_time_ms` em sucessos
- ‚úÖ **SEMPRE** usar `errors` como objeto em falhas

---

## üåç Sistema de Tradu√ß√µes (OBRIGAT√ìRIO)
### **REGRA FUNDAMENTAL: ZERO MENSAGENS HARD-CODED**
- **Arquivo principal:** `lang/pt_BR/app.php` - todas as mensagens customizadas
- **Laravel padr√£o:** `lang/pt_BR/validation.php`, `auth.php`, `passwords.php`
- **Uso obrigat√≥rio:** `__('app.profile.updated')` em vez de `'Perfil atualizado'`
- **Logs traduzidos:** `Log::info('üë• ' . __('app.logs.searching_user_network'))`
- **Estrutura organizada:** `app.{domain}.{action}` (ex: `app.user.not_found`)

### **Exemplos Pr√°ticos:**
```php
// ‚ùå ERRADO - mensagem hard-coded
return response()->json(['message' => 'Usu√°rio n√£o encontrado'], 404);

// ‚úÖ CORRETO - tradu√ß√£o
return response()->json(['message' => __('app.user.not_found')], 404);

// ‚ùå ERRADO - log hard-coded  
Log::info('Buscando usu√°rio');

// ‚úÖ CORRETO - log traduzido
Log::info('üîç ' . __('app.logs.searching_user'));
```

### **Estrutura do arquivo app.php:**
- `app.profile.*` - opera√ß√µes de perfil
- `app.user.*` - opera√ß√µes de usu√°rio  
- `app.validation.*` - valida√ß√µes customizadas
- `app.logs.*` - mensagens de log
- `app.jobs.*` - mensagens de jobs

---

##  Padr√µes Espec√≠ficos do Projeto
- **Rotas API:** `routes/api/v1/{auth,customer,administrator,shared,public}.php`
- **Controllers:** `app/Http/Controllers/Api/{Customer,Administrator,Public}/`
- **Middleware:** `auth:sanctum` para rotas protegidas
- **UUID patterns:** todos os models principais usam UUID como identificador externo
- **Logs com emojis:** facilita debug - `üõí`, `üìä`, `‚úÖ`, `‚ùå`, `üìß`, `üéØ` (conversions)
- **Status constants:** definir no Model (STATUS_DRAFT, STATUS_ACTIVE, etc.)
- **Lead Tracking:** Subscriber model com UTM tracking, device info, conversions

---

## üß† Instru√ß√µes para Copilot
Ao gerar c√≥digo:
1. **Priorize performance e seguran√ßa** - cache, valida√ß√£o, sanitiza√ß√£o
2. **Tipagem obrigat√≥ria** - `declare(strict_types=1)` em todos os arquivos
3. **Consultas otimizadas** - scopes, with(), select espec√≠fico, cache
4. **Logs estruturados** - contexto rico, emojis, arrays de dados
5. **Jobs idempotentes** - tries=3, timeout=120, logs de in√≠cio/fim
6. **BusinessRules services** - l√≥gica complexa isolada, inje√ß√£o de depend√™ncia
7. **Nunca usar helpers debug** - sem `dd()`, `dump()`, `env()` direto
8. **ZERO mensagens hard-coded** - usar `__('app.key')` √© OBRIGAT√ìRIO
9. **Tradu√ß√µes centralizadas** - `lang/pt_BR/app.php` para tudo
10. **Logs com tradu√ß√µes** - `Log::info('üîç ' . __('app.logs.action'))`
11. **JSON padronizado** - status/message/data/meta para sucesso, status/message/errors para falha
12. **Middlewares apropriados** - api.key para webhooks, auth:sanctum para usu√°rios, admin para administra√ß√£o
13. **Type casting seguro** - (string), (int) quando necess√°rio para strict types
14. **Valida√ß√£o com FormRequest** - nunca validar diretamente no Controller
15. **Collections Postman por dom√≠nio** - sempre atualizar a collection apropriada ao criar endpoints
16. **Scripts autom√°ticos obrigat√≥rios** - incluir extra√ß√£o de tokens/UUIDs e testes de valida√ß√£o
17. **Documenta√ß√£o simult√¢nea** - ao implementar endpoints, atualizar README da collection
18. **Environments consistentes** - usar vari√°veis padronizadas entre Local e Production
19. **Nomeneclatura de collections** - `Premia_Club_{Domain}_API.postman_collection.json`
20. **Organiza√ß√£o por pasta** - usar emojis e agrupamento l√≥gico (üõí Cart, üë• Users, etc.)

---

## üîÄ Boas Pr√°ticas Git
### **Commits Sem√¢nticos**
```
feat: adicionar endpoint para cancelar tickets de rifa
fix: corrigir c√°lculo de comiss√µes em m√∫ltiplos n√≠veis  
refactor: extrair l√≥gica de pagamento para PayCommissionService
docs: atualizar documenta√ß√£o da API de cart√µes
test: adicionar testes para AbandonedCartJob
chore: atualizar depend√™ncias do Laravel para v12.1
```

### **Branches Organizadas**
- **feature/** - novas funcionalidades (`feature/raffle-ticket-cancellation`)
- **fix/** - corre√ß√µes de bugs (`fix/commission-calculation-error`)  
- **hotfix/** - corre√ß√µes urgentes em produ√ß√£o (`hotfix/payment-gateway-timeout`)
- **refactor/** - melhorias de c√≥digo (`refactor/extract-business-rules-services`)

### **Pull Requests**
- **M√°ximo 500 linhas** por PR - se maior, quebrar em m√∫ltiplos PRs
- **T√≠tulo descritivo** seguindo padr√£o sem√¢ntico
- **Descri√ß√£o clara:** O que mudou, por que mudou, como testar
- **Review obrigat√≥rio** antes do merge
- **Testes passando** - CI/CD deve estar verde

### **Arquivos Ignorados**
Nunca commitar:
- `.env*` (credenciais e configura√ß√µes)
- `storage/logs/*` (logs de aplica√ß√£o)
- `bootstrap/cache/*` (cache do Laravel)
- `node_modules/` (depend√™ncias JS)
- `.DS_Store`, `Thumbs.db` (sistema operacional)

---

ü¶æ **Resumo Final**
> Sistema de rifas e comiss√µes com foco em performance e seguran√ßa.  
> Controllers finos, BusinessRules services, Jobs ass√≠ncronos, Models com UUIDs.  
> **REGRA ABSOLUTA: Tradu√ß√µes obrigat√≥rias, zero strings hard-coded.**  
> **JSON padronizado: status/message/data/meta sempre.**  
> **Middlewares: api.key para seguran√ßa, auth:sanctum para usu√°rios.**  
> **Tipagem estrita: declare(strict_types=1) em TODOS os arquivos.**  
> **Git sem√¢ntico, PRs pequenos, branches organizadas.**

**Status de Compliance: 100% ‚úÖ**  
- ‚úÖ **Arquitetura Laravel 12** - Strict typing em todos os arquivos PHP
- ‚úÖ **Sistema de tradu√ß√µes** - 90+ mensagens estruturadas em `lang/pt_BR/app.php`
- ‚úÖ **JSON responses padronizados** - status/message/data/meta obrigat√≥rios
- ‚úÖ **Middleware de seguran√ßa** - API Key, Rate Limiting, Auth Sanctum
- ‚úÖ **Validation Layer** - FormRequests para todas as valida√ß√µes
- ‚úÖ **Performance otimizada** - Cache, consultas otimizadas, Jobs ass√≠ncronos
- ‚úÖ **API p√∫blica completa** - Lead tracking com UTM e device fingerprinting
- ‚úÖ **Collections Postman v2.0** - Reorganiza√ß√£o por dom√≠nio implementada:
  - **Users/** - Autentica√ß√£o, perfil, admin CRUD (100% completo)
  - **Subscribers/** - Lead capture, status, unsubscribe (100% completo)
  - **Orders/** - Carrinho, pedidos, hist√≥rico, admin (100% completo)
  - **Raffles/** - Estrutura criada (0% implementado)
  - **Commissions/** - Estrutura criada (0% implementado)
- ‚úÖ **Automa√ß√£o completa** - Scripts autom√°ticos de token, UUID, valida√ß√£o
- ‚úÖ **Documenta√ß√£o profissional** - README completo da organiza√ß√£o por dom√≠nio
- ‚úÖ **Testing strategy** - 6 testes de API p√∫blica + valida√ß√µes autom√°ticas Postman
- ‚úÖ **Environment management** - Local/Production organizados
- ‚úÖ **Domain-Driven Design** - Separa√ß√£o clara por contextos de neg√≥cio
