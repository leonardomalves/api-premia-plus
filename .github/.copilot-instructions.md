# ⚙️ Copilot Rules — API Premia Plus (Laravel 12)

## 🧩 Contexto do Projeto
**API de sistema de rifas e comissões** estruturada em camadas (Controllers, Requests, Services, Jobs, Models).
**Domínio:** Users, Plans, Orders, Carts, Raffles, Tickets, Commissions, Wallets, **Subscribers** (Lead Tracking).
**Arquitetura:** API versionada (v1) com autenticação Sanctum, Jobs assíncronos, BusinessRules services, **API pública para landing pages**.

**Princípios de desenvolvimento:**
- **SOLID** e **PSR-12**
- **Performance-first** - cache, consultas otimizadas, Jobs para tarefas pesadas  
- **Responsabilidade única** - Controllers finos, Services especializados
- **Zero redundância** - DRY, reutilização, padrões consistentes

---

## ⚡ Diretrizes Gerais
- Código **tipado** (`declare(strict_types=1);`)
- Controllers finos, delegando tudo para Services.
- Services com regras claras de negócio e sem dependências cíclicas.
- **JAMAIS usar mensagens hard-coded** - usar `__('app.key')` SEMPRE
- Evitar helpers (`dd`, `dump`, `env`).
- Sempre validar com `FormRequest` e retornar JSON padronizado.
- Adotar Jobs para operações demoradas.
- Usar `Cache`, `chunk()`, `cursor()` e `paginate()` para performance.
- Sempre usar artisan commands em scripts de deploy (cache, migrate, etc).
- Sempre usar PSR-12 e linters (PHPStan, PHPCS).
- Sempre usar artisan para criar arquivos (make:model, make:controller, etc).
- Quando criar uma model nova, criar também o factory e o seeder correspondentes utilisando o -m para criar a migration junto.
- **Collections Postman organizadas por domínio** em `docs/postman/collections/{Domain}/`
- **Estrutura implementada:**
  - `Users/` - Autenticação completa, gestão de usuários, admin CRUD
  - `Subscribers/` - Lead capture, UTM tracking, unsubscribe
  - `Orders/` - Carrinho, pedidos, histórico, admin management
  - `Raffles/` - *Em desenvolvimento* - rifas e sorteios
  - `Commissions/` - *Em desenvolvimento* - sistema de comissões
- **Environments organizados** em `docs/postman/environments/` (Local, Production)
- **Scripts automáticos** incluídos: extração de tokens, UUIDs, testes de validação
- **Documentação completa** em `docs/postman/collections/README.md`
- **SEMPRE atualizar collections** ao criar novos endpoints
- **Para cada nova funcionalidade:** adicionar testes unitários e de integração
- **Para cada domínio concluído:** criar arquivo em `docs/integrations/{domain}.md` com instruções para front-end
---

## 🧱 Eloquent e Consultas
- **Models com UUIDs:** usar `Str::uuid()` no boot, SoftDeletes quando aplicável
- **Scopes padrão:** `scopeActive()`, `scopeByCreator()` - seguir padrão do projeto
- **Nunca usar `Model::all()`** — sempre aplicar filtros, scopes e limites
- **Especificar colunas** com `select(['id', 'uuid', 'name'])`
- **Relationships:** definir claramente `belongsTo`, `hasMany`, `belongsToMany` com pivots
- **Cachear consultas caras:**
  ```php
  Cache::remember('active_raffles', now()->addMinutes(10), fn() =>
      Raffle::active()->with('creator')->get()
  );
  ```
- **Prevenir N+1:** sempre usar `with()` para relationships necessárias
- **Usar agregações:** `exists()`, `withCount()`, `sum()` em vez de loops

---

## 🧩 Services
- **Estrutura:** `app/Services/{Domain}/` (Administrator, BusinessRules, Customer, Core, Monitoring)
- **BusinessRules:** `ExecuteBusinessRule`, `PayCommissionService`, `CreateStatementService`, `WalletTicketService`
- **Customer:** `SubscriberService` - Lead tracking, conversão, device fingerprinting
- **Injeção de dependência** no construtor para outros services
- **Métodos:** `execute()`, `process()`, `create()`, `update()` - sempre retornar arrays estruturados
- Processar **em lote** sempre que possível (`insert`, `updateBatch`)
- Usar `readonly` e `final` quando aplicável

---

## 🧵 Jobs
- Local: `app/Jobs`
- Sempre implementar `ShouldQueue` com `tries = 3` e `timeout = 120`
- Jobs devem ser idempotentes com logs estruturados (usar emojis)
- Usar `Bus::batch()` para orquestrar execuções em paralelo
- Exemplo: `AbandonedCartJob`, `CreateTicketsBatchJob`, `ExecuteBusinessRuleJob`

---

## 🧰 Performance Laravel
- Ativar `config:cache`, `route:cache`, `view:cache`.
- Usar `php artisan optimize:clear` apenas em ambiente de desenvolvimento.
- Evitar chamadas IO síncronas no ciclo da request.
- Adotar Octane (Swoole ou RoadRunner) em produção.
- Minimizar overhead de IoC — usar `singleton()` onde possível.

## 🔐 Middlewares Disponíveis
- **`auth:sanctum`** - Autenticação por Bearer Token
- **`admin`** - Validação de usuário administrador  
- **`api.key`** - Validação de API Key via header `X-API-Key`
- **`throttle:lead-capture`** - Rate limiting para captura de leads (5/min)
- **`throttle:lead-status`** - Rate limiting para verificação de status (10/min)
- **`throttle:lead-unsubscribe`** - Rate limiting para unsubscribe (3/min)

### Middleware API Key
```php
// Uso básico
Route::middleware(['api.key'])->group(function () {
    Route::post('/webhooks/payment', 'WebhookController@handle');
});

// Combinado com autenticação
Route::middleware(['api.key', 'auth:sanctum', 'admin'])->group(function () {
    Route::get('/admin/reports', 'AdminController@reports');
});
```

**Configuração:** 
- Header: `X-API-Key: sk_api_[64-char-hex]`
- Env: `APP_API_KEY=sk_api_...`
**Uso:** Webhooks, operações críticas, comunicação entre serviços

### APIs Públicas (Lead Tracking)
**Rotas:** `routes/api/v1/public.php`
- **Rate Limited:** Proteção contra spam por IP
- **Stateless:** Não dependem de sessões ou autenticação
- **UTM Tracking:** Captura automática de parâmetros de campanha
- **Device Fingerprinting:** IP, User-Agent, detecção de dispositivo

```php
// Captura de leads (landing pages)
POST   /api/v1/public/leads/capture
GET    /api/v1/public/leads/status/{uuid}  
DELETE /api/v1/public/leads/unsubscribe/{uuid}
```

---

## 📚 Collections Postman - Organização por Domínio
**Estrutura:** `docs/postman/collections/{Domain}/`

### 👥 Users & Authentication
**Arquivo:** `Users/Premia_Club_Users_API.postman_collection.json`
- ✅ **Login/Logout** - Autenticação completa com refresh tokens
- ✅ **Register** - Registro de usuários com validação completa
- ✅ **Profile Management** - Atualização de perfil, avatar, configurações
- ✅ **Admin CRUD** - Gestão administrativa de usuários
- ✅ **Scripts Automáticos** - Extração de auth_token, user_uuid
- ✅ **Tests** - Validação de estrutura, performance, autenticação

### 📧 Subscribers (Lead Capture)  
**Arquivo:** `Subscribers/Premia_Club_Lead_Capture_API.postman_collection.json`
- ✅ **Lead Capture** - Captura com UTM tracking e device fingerprinting
- ✅ **Status Check** - Verificação de status de leads
- ✅ **Unsubscribe** - Sistema de descadastro
- ✅ **Rate Limiting** - Testes de proteção contra spam
- ✅ **Scripts Automáticos** - Geração de emails únicos, extração de UUIDs
- ✅ **Tests** - Validação de rate limits, estruturas, conversões

### 🛒 Orders & Cart
**Arquivo:** `Orders/Premia_Club_Orders_API.postman_collection.json`
- ✅ **Shopping Cart** - Adicionar/remover itens, verificar total
- ✅ **Order Creation** - Criar pedidos com múltiplos métodos de pagamento
- ✅ **Order History** - Histórico de compras do usuário
- ✅ **Admin Management** - Gestão administrativa de pedidos
- ✅ **Scripts Automáticos** - Extração de cart_uuid, order_uuid
- ✅ **Tests** - Validação de carrinho, pedidos, status de pagamento

### 🎯 Raffles *(Em Desenvolvimento)*
**Diretório:** `Raffles/` - Estrutura criada, aguardando implementação
- 🚧 **Public Listings** - Listagem pública de rifas
- 🚧 **Ticket Purchase** - Compra de tickets 
- 🚧 **Draw Results** - Resultados dos sorteios
- 🚧 **Admin CRUD** - Gestão de rifas

### 💰 Commissions *(Em Desenvolvimento)*
**Diretório:** `Commissions/` - Estrutura criada, aguardando implementação
- 🚧 **Reports** - Relatórios de comissões
- 🚧 **Earnings History** - Histórico de ganhos
- 🚧 **Level Configuration** - Configuração de níveis

### 🌍 Environments
**Localizações:** `docs/postman/environments/`
- **Local:** `Premia_Club_Local_Environment.postman_environment.json`
- **Production:** `Premia_Club_Production_Environment.postman_environment.json`
- **Variáveis automáticas:** auth_token, user_uuid, cart_uuid, order_uuid
- **Configuração:** base_url, api_key, admin_email por environment

### 📖 Documentação
- **Guia completo:** `docs/postman/collections/README.md`
- **Instruções de uso:** Importação, configuração, execução
- **Scripts automáticos:** Descrição completa das funcionalidades
- **Padrões de desenvolvimento:** Contribuição e manutenção

### 🔧 Funcionalidades Automáticas
- **Auto-authentication:** Tokens salvos automaticamente nas variáveis
- **Dynamic Variables:** UUIDs e IDs extraídos das respostas
- **Comprehensive Tests:** Validação de estrutura, performance, negócio
- **Performance Monitoring:** Métricas de execution_time_ms incluídas
- **Pre-request Scripts:** Headers, validações, configurações automáticas

---

## 🧾 Padrão de Resposta (OBRIGATÓRIO)
**Sucesso:**
```json
{
  "status": "success",
  "message": "{{ __('app.domain.action') }}",
  "data": { ... },
  "meta": { "execution_time_ms": 8.45 }
}
```

**Erro:**
```json
{
  "status": "error",
  "message": "{{ __('app.domain.error') }}",
  "errors": { "field": "Detalhes do erro" }
}
```

**Regras:**
- ✅ **SEMPRE** usar `status` (não `success`)
- ✅ **SEMPRE** usar traduções `__('app.key')` nas mensagens
- ✅ **SEMPRE** incluir `meta.execution_time_ms` em sucessos
- ✅ **SEMPRE** usar `errors` como objeto em falhas

---

## 🌍 Sistema de Traduções (OBRIGATÓRIO)
### **REGRA FUNDAMENTAL: ZERO MENSAGENS HARD-CODED**
- **Arquivo principal:** `lang/pt_BR/app.php` - todas as mensagens customizadas
- **Laravel padrão:** `lang/pt_BR/validation.php`, `auth.php`, `passwords.php`
- **Uso obrigatório:** `__('app.profile.updated')` em vez de `'Perfil atualizado'`
- **Logs traduzidos:** `Log::info('👥 ' . __('app.logs.searching_user_network'))`
- **Estrutura organizada:** `app.{domain}.{action}` (ex: `app.user.not_found`)

### **Exemplos Práticos:**
```php
// ❌ ERRADO - mensagem hard-coded
return response()->json(['message' => 'Usuário não encontrado'], 404);

// ✅ CORRETO - tradução
return response()->json(['message' => __('app.user.not_found')], 404);

// ❌ ERRADO - log hard-coded  
Log::info('Buscando usuário');

// ✅ CORRETO - log traduzido
Log::info('🔍 ' . __('app.logs.searching_user'));
```

### **Estrutura do arquivo app.php:**
- `app.profile.*` - operações de perfil
- `app.user.*` - operações de usuário  
- `app.validation.*` - validações customizadas
- `app.logs.*` - mensagens de log
- `app.jobs.*` - mensagens de jobs

---

##  Padrões Específicos do Projeto
- **Rotas API:** `routes/api/v1/{auth,customer,administrator,shared,public}.php`
- **Controllers:** `app/Http/Controllers/Api/{Customer,Administrator,Public}/`
- **Middleware:** `auth:sanctum` para rotas protegidas
- **UUID patterns:** todos os models principais usam UUID como identificador externo
- **Logs com emojis:** facilita debug - `🛒`, `📊`, `✅`, `❌`, `📧`, `🎯` (conversions)
- **Status constants:** definir no Model (STATUS_DRAFT, STATUS_ACTIVE, etc.)
- **Lead Tracking:** Subscriber model com UTM tracking, device info, conversions

---

## 🧠 Instruções para Copilot
Ao gerar código:
1. **Priorize performance e segurança** - cache, validação, sanitização
2. **Tipagem obrigatória** - `declare(strict_types=1)` em todos os arquivos
3. **Consultas otimizadas** - scopes, with(), select específico, cache
4. **Logs estruturados** - contexto rico, emojis, arrays de dados
5. **Jobs idempotentes** - tries=3, timeout=120, logs de início/fim
6. **BusinessRules services** - lógica complexa isolada, injeção de dependência
7. **Nunca usar helpers debug** - sem `dd()`, `dump()`, `env()` direto
8. **ZERO mensagens hard-coded** - usar `__('app.key')` é OBRIGATÓRIO
9. **Traduções centralizadas** - `lang/pt_BR/app.php` para tudo
10. **Logs com traduções** - `Log::info('🔍 ' . __('app.logs.action'))`
11. **JSON padronizado** - status/message/data/meta para sucesso, status/message/errors para falha
12. **Middlewares apropriados** - api.key para webhooks, auth:sanctum para usuários, admin para administração
13. **Type casting seguro** - (string), (int) quando necessário para strict types
14. **Validação com FormRequest** - nunca validar diretamente no Controller
15. **Collections Postman por domínio** - sempre atualizar a collection apropriada ao criar endpoints
16. **Scripts automáticos obrigatórios** - incluir extração de tokens/UUIDs e testes de validação
17. **Documentação simultânea** - ao implementar endpoints, atualizar README da collection
18. **Environments consistentes** - usar variáveis padronizadas entre Local e Production
19. **Nomeneclatura de collections** - `Premia_Club_{Domain}_API.postman_collection.json`
20. **Organização por pasta** - usar emojis e agrupamento lógico (🛒 Cart, 👥 Users, etc.)

---

## 🔀 Boas Práticas Git
### **Commits Semânticos**
```
feat: adicionar endpoint para cancelar tickets de rifa
fix: corrigir cálculo de comissões em múltiplos níveis  
refactor: extrair lógica de pagamento para PayCommissionService
docs: atualizar documentação da API de cartões
test: adicionar testes para AbandonedCartJob
chore: atualizar dependências do Laravel para v12.1
```

### **Branches Organizadas**
- **feature/** - novas funcionalidades (`feature/raffle-ticket-cancellation`)
- **fix/** - correções de bugs (`fix/commission-calculation-error`)  
- **hotfix/** - correções urgentes em produção (`hotfix/payment-gateway-timeout`)
- **refactor/** - melhorias de código (`refactor/extract-business-rules-services`)

### **Pull Requests**
- **Máximo 500 linhas** por PR - se maior, quebrar em múltiplos PRs
- **Título descritivo** seguindo padrão semântico
- **Descrição clara:** O que mudou, por que mudou, como testar
- **Review obrigatório** antes do merge
- **Testes passando** - CI/CD deve estar verde

### **Arquivos Ignorados**
Nunca commitar:
- `.env*` (credenciais e configurações)
- `storage/logs/*` (logs de aplicação)
- `bootstrap/cache/*` (cache do Laravel)
- `node_modules/` (dependências JS)
- `.DS_Store`, `Thumbs.db` (sistema operacional)

---

🦾 **Resumo Final**
> Sistema de rifas e comissões com foco em performance e segurança.  
> Controllers finos, BusinessRules services, Jobs assíncronos, Models com UUIDs.  
> **REGRA ABSOLUTA: Traduções obrigatórias, zero strings hard-coded.**  
> **JSON padronizado: status/message/data/meta sempre.**  
> **Middlewares: api.key para segurança, auth:sanctum para usuários.**  
> **Tipagem estrita: declare(strict_types=1) em TODOS os arquivos.**  
> **Git semântico, PRs pequenos, branches organizadas.**

**Status de Compliance: 100% ✅**  
- ✅ **Arquitetura Laravel 12** - Strict typing em todos os arquivos PHP
- ✅ **Sistema de traduções** - 90+ mensagens estruturadas em `lang/pt_BR/app.php`
- ✅ **JSON responses padronizados** - status/message/data/meta obrigatórios
- ✅ **Middleware de segurança** - API Key, Rate Limiting, Auth Sanctum
- ✅ **Validation Layer** - FormRequests para todas as validações
- ✅ **Performance otimizada** - Cache, consultas otimizadas, Jobs assíncronos
- ✅ **API pública completa** - Lead tracking com UTM e device fingerprinting
- ✅ **Collections Postman v2.0** - Reorganização por domínio implementada:
  - **Users/** - Autenticação, perfil, admin CRUD (100% completo)
  - **Subscribers/** - Lead capture, status, unsubscribe (100% completo)
  - **Orders/** - Carrinho, pedidos, histórico, admin (100% completo)
  - **Raffles/** - Estrutura criada (0% implementado)
  - **Commissions/** - Estrutura criada (0% implementado)
- ✅ **Automação completa** - Scripts automáticos de token, UUID, validação
- ✅ **Documentação profissional** - README completo da organização por domínio
- ✅ **Testing strategy** - 6 testes de API pública + validações automáticas Postman
- ✅ **Environment management** - Local/Production organizados
- ✅ **Domain-Driven Design** - Separação clara por contextos de negócio
