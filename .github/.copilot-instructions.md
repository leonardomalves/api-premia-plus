# ‚öôÔ∏è Copilot Rules ‚Äî API Premia Plus (Laravel 12)

## üß© Contexto do Projeto
**API de sistema de rifas e comiss√µes** estruturada em camadas (Controllers, Requests, Services, Jobs, Models).
**Dom√≠nio:** Users, Plans, Orders, Carts, Raffles, Tickets, Commissions, Wallets.
**Arquitetura:** API versionada (v1) com autentica√ß√£o Sanctum, Jobs ass√≠ncronos, BusinessRules services.

**Princ√≠pios de desenvolvimento:**
- **SOLID** e **PSR-12**
- **Performance-first** - cache, consultas otimizadas, Jobs para tarefas pesadas  
- **Responsabilidade √∫nica** - Controllers finos, Services especializados
- **Zero redund√¢ncia** - DRY, reutiliza√ß√£o, padr√µes consistentes

---

## ‚ö° Diretrizes Gerais
- C√≥digo **tipado** (`declare(strict_types=1);`)
- Controllers finos, delegando tudo para Services.
- Services com regras claras de neg√≥cio e sem depend√™ncias c√≠clicas.
- **JAMAIS usar mensagens hard-coded** - usar `__('app.key')` SEMPRE
- Evitar helpers (`dd`, `dump`, `env`).
- Sempre validar com `FormRequest` e retornar JSON padronizado.
- Adotar Jobs para opera√ß√µes demoradas.
- Usar `Cache`, `chunk()`, `cursor()` e `paginate()` para performance.

---

## üß± Eloquent e Consultas
- **Models com UUIDs:** usar `Str::uuid()` no boot, SoftDeletes quando aplic√°vel
- **Scopes padr√£o:** `scopeActive()`, `scopeByCreator()` - seguir padr√£o do projeto
- **Nunca usar `Model::all()`** ‚Äî sempre aplicar filtros, scopes e limites
- **Especificar colunas** com `select(['id', 'uuid', 'name'])`
- **Relationships:** definir claramente `belongsTo`, `hasMany`, `belongsToMany` com pivots
- **Cachear consultas caras:**
  ```php
  Cache::remember('active_raffles', now()->addMinutes(10), fn() =>
      Raffle::active()->with('creator')->get()
  );
  ```
- **Prevenir N+1:** sempre usar `with()` para relationships necess√°rias
- **Usar agrega√ß√µes:** `exists()`, `withCount()`, `sum()` em vez de loops

---

## üß© Services
- **Estrutura:** `app/Services/{Domain}/` (Administrator, BusinessRules, Customer, Core, Monitoring)
- **BusinessRules:** `ExecuteBusinessRule`, `PayCommissionService`, `CreateStatementService`, `WalletTicketService`
- **Inje√ß√£o de depend√™ncia** no construtor para outros services
- **M√©todos:** `execute()`, `process()`, `create()`, `update()` - sempre retornar arrays estruturados
- Processar **em lote** sempre que poss√≠vel (`insert`, `updateBatch`)
- Usar `readonly` e `final` quando aplic√°vel

---

## üßµ Jobs
- Local: `app/Jobs`
- Sempre implementar `ShouldQueue` com `tries = 3` e `timeout = 120`
- Jobs devem ser idempotentes com logs estruturados (usar emojis)
- Usar `Bus::batch()` para orquestrar execu√ß√µes em paralelo
- Exemplo: `AbandonedCartJob`, `CreateTicketsBatchJob`, `ExecuteBusinessRuleJob`

---

## üß∞ Performance Laravel
- Ativar `config:cache`, `route:cache`, `view:cache`.
- Usar `php artisan optimize:clear` apenas em ambiente de desenvolvimento.
- Evitar chamadas IO s√≠ncronas no ciclo da request.
- Adotar Octane (Swoole ou RoadRunner) em produ√ß√£o.
- Minimizar overhead de IoC ‚Äî usar `singleton()` onde poss√≠vel.

---

## üßæ Padr√£o de Resposta
**Sucesso:**
```json
{
  "status": "success",
  "message": "Opera√ß√£o conclu√≠da.",
  "data": { ... },
  "meta": { "execution_time_ms": 8 }
}
```

**Erro:**
```json
{
  "status": "error",
  "message": "Falha ao processar requisi√ß√£o.",
  "errors": { ... }
}
```

---

## üåç Sistema de Tradu√ß√µes (OBRIGAT√ìRIO)
### **REGRA FUNDAMENTAL: ZERO MENSAGENS HARD-CODED**
- **Arquivo principal:** `lang/pt_BR/app.php` - todas as mensagens customizadas
- **Laravel padr√£o:** `lang/pt_BR/validation.php`, `auth.php`, `passwords.php`
- **Uso obrigat√≥rio:** `__('app.profile.updated')` em vez de `'Perfil atualizado'`
- **Logs traduzidos:** `Log::info('üë• ' . __('app.logs.searching_user_network'))`
- **Estrutura organizada:** `app.{domain}.{action}` (ex: `app.user.not_found`)

### **Exemplos Pr√°ticos:**
```php
// ‚ùå ERRADO - mensagem hard-coded
return response()->json(['message' => 'Usu√°rio n√£o encontrado'], 404);

// ‚úÖ CORRETO - tradu√ß√£o
return response()->json(['message' => __('app.user.not_found')], 404);

// ‚ùå ERRADO - log hard-coded  
Log::info('Buscando usu√°rio');

// ‚úÖ CORRETO - log traduzido
Log::info('üîç ' . __('app.logs.searching_user'));
```

### **Estrutura do arquivo app.php:**
- `app.profile.*` - opera√ß√µes de perfil
- `app.user.*` - opera√ß√µes de usu√°rio  
- `app.validation.*` - valida√ß√µes customizadas
- `app.logs.*` - mensagens de log
- `app.jobs.*` - mensagens de jobs

---

## ÔøΩüéØ Padr√µes Espec√≠ficos do Projeto
- **Rotas API:** `routes/api/v1/{auth,customer,administrator,shared}.php`
- **Controllers:** `app/Http/Controllers/Api/{Customer,Administrator}/`
- **Middleware:** `auth:sanctum` para rotas protegidas
- **UUID patterns:** todos os models principais usam UUID como identificador externo
- **Logs com emojis:** facilita debug - `üõí`, `üìä`, `‚úÖ`, `‚ùå`, `üìß`
- **Status constants:** definir no Model (STATUS_DRAFT, STATUS_ACTIVE, etc.)

---

## üß† Instru√ß√µes para Copilot
Ao gerar c√≥digo:
1. **Priorize performance e seguran√ßa** - cache, valida√ß√£o, sanitiza√ß√£o
2. **Tipagem obrigat√≥ria** - `declare(strict_types=1)` em todos os arquivos
3. **Consultas otimizadas** - scopes, with(), select espec√≠fico, cache
4. **Logs estruturados** - contexto rico, emojis, arrays de dados
5. **Jobs idempotentes** - tries=3, timeout=120, logs de in√≠cio/fim
6. **BusinessRules services** - l√≥gica complexa isolada, inje√ß√£o de depend√™ncia
7. **Nunca usar helpers debug** - sem `dd()`, `dump()`, `env()` direto
8. **ZERO mensagens hard-coded** - usar `__('app.key')` √© OBRIGAT√ìRIO
9. **Tradu√ß√µes centralizadas** - `lang/pt_BR/app.php` para tudo
10. **Logs com tradu√ß√µes** - `Log::info('üîç ' . __('app.logs.action'))`

---

## üîÄ Boas Pr√°ticas Git
### **Commits Sem√¢nticos**
```
feat: adicionar endpoint para cancelar tickets de rifa
fix: corrigir c√°lculo de comiss√µes em m√∫ltiplos n√≠veis  
refactor: extrair l√≥gica de pagamento para PayCommissionService
docs: atualizar documenta√ß√£o da API de cart√µes
test: adicionar testes para AbandonedCartJob
chore: atualizar depend√™ncias do Laravel para v12.1
```

### **Branches Organizadas**
- **feature/** - novas funcionalidades (`feature/raffle-ticket-cancellation`)
- **fix/** - corre√ß√µes de bugs (`fix/commission-calculation-error`)  
- **hotfix/** - corre√ß√µes urgentes em produ√ß√£o (`hotfix/payment-gateway-timeout`)
- **refactor/** - melhorias de c√≥digo (`refactor/extract-business-rules-services`)

### **Pull Requests**
- **M√°ximo 500 linhas** por PR - se maior, quebrar em m√∫ltiplos PRs
- **T√≠tulo descritivo** seguindo padr√£o sem√¢ntico
- **Descri√ß√£o clara:** O que mudou, por que mudou, como testar
- **Review obrigat√≥rio** antes do merge
- **Testes passando** - CI/CD deve estar verde

### **Arquivos Ignorados**
Nunca commitar:
- `.env*` (credenciais e configura√ß√µes)
- `storage/logs/*` (logs de aplica√ß√£o)
- `bootstrap/cache/*` (cache do Laravel)
- `node_modules/` (depend√™ncias JS)
- `.DS_Store`, `Thumbs.db` (sistema operacional)

---

ü¶æ **Resumo Final**
> Sistema de rifas e comiss√µes com foco em performance.  
> Controllers finos, BusinessRules services, Jobs ass√≠ncronos, Models com UUIDs.  
> **REGRA ABSOLUTA: Tradu√ß√µes obrigat√≥rias, zero strings hard-coded.**  
> **Git sem√¢ntico, PRs pequenos, branches organizadas.**
